<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ğŸ¥ºã·ã‚†ã‚†ãªé›†ä¼šå ´ğŸ¥º - ã·ã‚†ã‚†å¥½ãã®ãŸã‚ã®åŒ¿åæ²ç¤ºæ¿</title>
<meta name="description" content="ã·ã‚†ã‚†ğŸ¥ºå¥½ããŒã“ãã£ã¦é›†ã¾ã‚‹ã¨å™‚ã®æ²ç¤ºæ¿" />
<meta name="keywords" content="æ²ç¤ºæ¿,åŒ¿å,é›‘è«‡,è¶£å‘³,ã·ã‚†ã‚†" />
<meta property="og:title" content="ğŸ¥ºã·ã‚†ã‚†ãªé›†ä¼šå ´ğŸ¥º" />
<meta property="og:description" content="ã·ã‚†ã‚†ğŸ¥ºå¥½ããŒã“ãã£ã¦é›†ã¾ã‚‹ã¨å™‚ã®æ²ç¤ºæ¿" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://hikakinmania4-cmyk.github.io/puyuyu-na-shukaijo/" />
<meta property="og:image" content="https://i.ibb.co/93Stdh8x/96a86591b41f.jpg" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="author" content="puyuyu" />
<meta name="theme-color" content="#1565c0" />

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<style>
  /* --- CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯å¤‰æ›´ãªã— --- */
  :root{--primary:#1565c0;--accent:#0288d1;--bg:#f5f7fb;--card:#ffffff;--muted:#6b7280;--danger:#ef4444;--text-main:#111827;--text-muted:#6b7280;--border-color:#e5e7eb;}
  .dark-mode{--primary:#60a5fa;--accent:#38bdf8;--bg:#111827;--card:#1f2937;--muted:#9ca3af;--text-main:#f9fafb;--text-muted:#9ca3af;--border-color:#374151;}
  *{box-sizing:border-box}
  body{font-family: system-ui,-apple-system,"Segoe UI",Roboto,"Hiragin- Kaku Gothic ProN",Meiryo,sans-serif;background:var(--bg);margin:0;padding:0;color:var(--text-main);transition:background-color .3s,color .3s;}
  header{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;padding:12px 16px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;}
  header h1{margin:0;font-size:18px;flex-grow:1;word-break:break-all;}
  header .controls{display:flex;gap:8px;align-items:center;}
  header .userbox{font-size:13px; margin-left: auto; text-align:right;}
  header button{background:rgba(255,255,255,0.14);border:none;color:#fff;padding:6px 10px;border-radius:6px;cursor:pointer; display: inline-flex; align-items: center; gap: 6px; position:relative;}
  header button:hover{background:rgba(255,255,255,0.22)}
  .wrap{max-width:1000px;margin:16px auto;padding:12px}
  .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(2,6,23,0.06);margin-bottom:12px;border:1px solid var(--border-color); transition: background-color .3s, border-color .3s;}
  .card h2{margin:0 0 8px 0;font-size:16px;color:var(--primary);word-break:break-all;}
  .thread-header{display:flex;flex-wrap:nowrap;justify-content:space-between;align-items:flex-start;gap:16px;}
  .thread-header-main{min-width:0;flex-grow:1;}
  .thread-header-meta{text-align:right;flex-shrink:0;}
  input[type="text"],textarea,select{width:100%;padding:8px;border:1px solid var(--border-color);border-radius:8px;font-size:14px;background:var(--card);color:var(--text-main);}
  textarea{min-height:80px;resize:vertical}
  .btn{background:var(--accent);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;transition:background-color 0.2s;}
  .btn:disabled{background:var(--muted);cursor:not-allowed;}
  .btn.warn{background:var(--danger)}
  .btn.small{padding:6px 8px;font-size:13px;border-radius:6px}
  .btn.liked{background:#e11d48;color:white;}
  .search-box{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
  .sort-box{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap; align-items: center;}
  .thread-item, .history-item{padding:10px;border-radius:8px;border:1px solid var(--border-color);display:flex;flex-wrap:nowrap;align-items:center;gap:12px; margin-bottom: 8px;}
  .thread-link{font-weight:600;color:var(--primary);text-decoration:none; display:block;word-break:break-all;}
  .thread-info { flex-grow: 1; display: flex; min-width: 0; }
  .thread-item .thread-info { flex-direction: column; align-items: flex-start; gap: 4px; }
  .history-item .thread-info { flex-direction: column; align-items: flex-start; gap: 4px; position: relative; padding-bottom: 18px; }
  .history-item-res-count { position: absolute; bottom: 0; left: 0; }
  .history-achievement-notify { font-weight: bold; color: var(--primary); font-size: 13px; margin-top: 4px; }
  .thread-tags{display:flex;flex-wrap:wrap;gap:4px;}
  .tag{background:var(--muted);color:var(--text-main);padding:2px 6px;border-radius:4px;font-size:11px;cursor:pointer; text-decoration: none;}
  .thread-title-wrapper{min-width:0;display:flex;align-items:center;gap:8px;}
  .thread-meta-info{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;text-align:right;}
  .thread-preview-img{width:60px;height:60px;object-fit:cover;border-radius:6px;flex-shrink:0;}
  .meta{font-size:13px;color:var(--text-muted)}
  .post{padding:10px;border-top:1px solid var(--border-color);margin-top:8px;}
  #postsContainer > .post:first-child{margin-top:0;}
  .modal-body .post {border-top:none; border-bottom:1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px;}
  .modal-body .post:last-child {border-bottom:none; margin-bottom:0;}
  .post .meta{font-size:12px;color:var(--text-muted);display:flex;gap:8px;align-items:center;flex-wrap:wrap; margin-bottom: 8px;}
  .post .meta .no{color:var(--accent);cursor:pointer;font-weight:700}
  .post .meta .post-author{font-weight:bold;cursor:pointer; color: var(--text-main);}
  .post .body{white-space:pre-wrap;word-break:break-word}
  .post .body a{color:var(--primary);}
  .post-image{max-width:280px;height:auto;border-radius:6px;margin-top:8px;display:block;cursor:pointer}
  .highlight{background-color: yellow; color: black;}
  .controls{margin-top:8px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
  .timestamp{margin-left:auto; white-space:nowrap;}
  .badge-op, .badge-level{background:var(--primary);color:white;padding:3px 6px;border-radius:999px;font-size:12px; white-space:nowrap;}
  .badge-new, .badge-anchor{display:inline-flex;align-items:center;justify-content:center;min-width:18px;height:18px;border-radius:999px;background:var(--danger);color:white;font-size:11px;font-weight:bold;padding:0 5px;}
  #historyUnreadBadge, #achievementBadge {position:absolute;top:-6px;right:-6px;line-height:1;box-shadow:0 1px 3px rgba(0,0,0,0.3);}
  #achievementBadge { background-color: #1565c0; }
  .unread-notification{margin-top:4px;}
  .unread-notification .badge-new{font-size:12px;padding:3px 8px;}
  .badge-anchor{cursor:pointer;}
  .banned-note, .deleted-note, .ng-hidden-post{color:var(--danger);font-weight:700;margin-top:8px;}
  .ng-word-red{color:var(--danger);font-weight:bold;}
  .thread-link.ng-word-red { color: var(--danger); }
  .search-highlight { color: var(--danger); font-weight: bold; background-color: rgba(239, 68, 68, 0.1); }
  .dice-result { color: #ff8c00; font-weight: bold; }
  .small-muted{font-size:12px;color:var(--text-muted)}
  .modal-overlay,.lightbox-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:1000;}
  .modal-content{background:var(--bg);border-radius:10px;width:90%;max-width:600px;max-height:80%;display:flex;flex-direction:column;border:1px solid var(--border-color);}
  .modal-header{padding:12px 16px;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center;}
  .modal-header h2{font-size:18px;color:var(--primary);margin:0;}
  .modal-close-btn,.lightbox-close-btn{font-size:28px;background:none;border:none;cursor:pointer;color:white;position:absolute;top:10px;right:15px;}
  .modal-close-btn{color:var(--text-muted);position:static;}
  .modal-body{padding:16px;overflow-y:auto;}
  #profileId{color:var(--text-muted);font-size:13px;margin:0 0 12px 0;word-break:break-all;}
  #profileControls{margin-bottom:12px; border-top:1px solid var(--border-color); padding-top:12px; display:flex; gap:8px;}
  .lightbox-content img{max-width:90vw;max-height:90vh;display:block;}
  .vote-box{margin-top:10px; display:flex; flex-direction:column; gap: 5px;}
  .vote-option-bar-container{display: flex; align-items: center; gap: 8px; padding: 4px; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; transition: background-color .2s;}
  .vote-option-bar-container:hover{background-color: rgba(128,128,128,0.1);}
  .vote-option-bar-container.voted-by-user{border-color: var(--primary); background-color: rgba(21,101,192,0.08);}
  .vote-option-bar-container.expired{cursor:not-allowed;}
  .vote-option-bar-container.expired:hover{background-color: transparent;}
  .vote-label{flex-shrink: 0; font-size: 14px;}
  .vote-bar-wrapper{flex-grow: 1; background-color: var(--border-color); border-radius: 4px; height: 20px; overflow: hidden;}
  .vote-option-bar{background-color: var(--accent); height: 100%; transition: width .3s ease-out, background-color .3s;}
  .vote-result{font-size: 13px; font-weight: bold; min-width: 60px; text-align: right;}
  .pagination-controls{display:flex;justify-content:center;align-items:center;gap:12px;margin-top:16px;}
  .achievement-item { display: flex; align-items: center; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
  .achievement-item:last-child { border-bottom: none; }
  .achievement-info { flex-grow: 1; }
  .achievement-title { font-weight: bold; }
  .achievement-desc { font-size: 12px; color: var(--text-muted); }
  .achievement-status { font-size: 12px; font-weight: bold; padding: 4px 8px; border-radius: 999px; }
  .status-unlocked { background-color: #4caf50; color: white; }
  .status-locked { background-color: var(--muted); color: var(--text-main); }
  @keyframes shake-animation { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
  @keyframes rainbow-animation { 0%,100% { color: red; } 16% { color: orange; } 33% { color: yellow; } 50% { color: green; } 66% { color: blue; } 83% { color: indigo; } }
  .effect-shake-active { animation: shake-animation 0.5s ease-in-out 6; }
  .effect-rainbow-active .body { animation: rainbow-animation 2s linear infinite; }
  .embed-container { position: relative; overflow: hidden; width: 100%; padding-top: 56.25%; margin: 8px 0; border-radius: 6px; }
  .embed-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
  .embedded-video { max-width: 100%; border-radius: 6px; margin-top: 8px; }
  .twitter-tweet { margin: 16px auto !important; }
  #drawingCanvas { border: 1px solid var(--border-color); border-radius: 6px; touch-action: none; cursor: crosshair; }
  .drawing-controls { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 10px; }
  .drawing-controls label { font-size: 13px; }
  .drawing-controls input[type="color"] { width: 40px; height: 30px; padding: 2px; border: none; border-radius: 4px; cursor: pointer; background: none; }
  .drawing-controls input[type="range"] { flex-grow: 1; }
  .drawing-controls .tool-btn { font-size: 13px; padding: 6px 8px; line-height: 1; }
  .drawing-controls .tool-btn.active { background-color: var(--primary); color: white; }
  #drawingModal .modal-content { max-width: 95%; width: 520px; }
  #drawingPreviewContainer { margin-top: 8px; }
  #drawingPreview { max-width: 150px; border-radius: 6px; border: 1px solid var(--border-color); }
  #clearDrawingBtn { margin-left: auto; }
  @media(max-width:680px){header{justify-content:center;}header .userbox{width:100%;text-align:center;margin:4px 0;}}
</style>
</head>
<body>
  <header>
    <h1>ğŸ¥ºã·ã‚†ã‚†ãªé›†ä¼šå ´ğŸ¥º</h1>
    <div class="userbox"><span id="userDisplay"></span></div>
    <div class="controls">
      <button id="homeBtn">ğŸ  ãƒ›ãƒ¼ãƒ </button>
      <button id="historyBtn">ğŸ“œ å±¥æ­´<span id="historyUnreadBadge" class="badge-new" style="display:none;"></span><span id="achievementBadge" class="badge-new" style="display:none; background-color: #1565c0;"></span></button>
      <button id="settingsBtn">âš™ï¸ è¨­å®š</button>
      <button id="themeToggleBtn">ğŸŒ™</button>
      <button id="refreshBtn">ğŸ”„ æ›´æ–°</button>
    </div>
  </header>

  <div class="wrap" id="app">
    <div class="card">
      <h2>æ–°ã—ã„ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä½œæˆ</h2>
      <input id="newTitle" type="text" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ#ã‚¿ã‚° ã§ã‚¿ã‚°ä»˜ã‘ã§ãã¾ã™ï¼‰" style="margin-bottom:8px;">
      <input id="newName" type="text" placeholder="åå‰ï¼ˆä»»æ„ï¼‰" style="margin-bottom:8px;">
      <textarea id="newText" placeholder="æœ¬æ–‡"></textarea>
      <div class="controls" style="justify-content:flex-start; margin-top:8px; gap:8px;">
        <button id="createVoteBtn" class="btn small">ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆä½œæˆ</button>
        <button id="createDrawBtn" class="btn small">ğŸ¨ ãŠçµµæã</button>
      </div>
      <div style="margin-top:8px;">
        <label for="levelRestrictionSelect" class="small-muted">ãƒ¬ãƒ™ãƒ«åˆ¶é™:</label>
        <select id="levelRestrictionSelect">
          <option value="0">ç„¡åˆ¶é™</option>
          <option value="10">Lv.10ä»¥ä¸Š</option>
          <option value="30">Lv.30ä»¥ä¸Š</option>
          <option value="60">Lv.60ä»¥ä¸Š</option>
          <option value="250">Lv.250ä»¥ä¸Š</option>
          <option value="500">Lv.500ä»¥ä¸Š</option>
          <option value="1000">Lv.1000ä»¥ä¸Š</option>
        </select>
      </div>
      <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center;">
        <div id="newImageContainer"><input id="newImage" type="file" accept="image/*"></div>
        <button class="btn" id="createThreadBtn">ã‚¹ãƒ¬ä½œæˆ</button>
      </div>
    </div>
    <div class="card">
      <h2>ã‚¹ãƒ¬ãƒƒãƒ‰ä¸€è¦§</h2>
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ã‚¿ã‚¤ãƒˆãƒ«æ¤œç´¢ or #ã‚¿ã‚°å">
        <button id="searchBtn" class="btn small">æ¤œç´¢</button>
        <button id="clearSearchBtn" class="btn small">ã‚¯ãƒªã‚¢</button>
        <a href="#memories" class="btn small" style="margin-left:auto; text-decoration:none;">ğŸ† ãƒ¡ãƒ¢ãƒªãƒ¼ã‚º</a>
      </div>
      <div class="sort-box">
        <span class="small-muted">ä¸¦ã³æ›¿ãˆ:</span>
        <select id="sortSelect">
          <option value="newPost" selected>æ–°ç€ãƒ¬ã‚¹é †</option>
          <option value="newThread">ã‚¹ãƒ¬ç«‹ã¦é †</option>
          <option value="manyRes">ãƒ¬ã‚¹æ•°é †</option>
          <option value="momentum">å‹¢ã„é †</option>
        </select>
        <label for="sortReverseCheckbox" class="small-muted" style="display:flex;align-items:center;gap:4px;">
          <input type="checkbox" id="sortReverseCheckbox">é€†é †
        </label>
      </div>

      <!-- â–¼â–¼â–¼ ã“ã“ã‹ã‚‰ãŒEJSã«ã‚ˆã‚‹HTMLç”Ÿæˆéƒ¨åˆ† â–¼â–¼â–¼ -->
      <div id="threadListContainer">
        <% if (typeof allThreads !== 'undefined' && allThreads.length > 0) { %>
          <% allThreads.forEach(t => { %>
            <% const postCount = t.postCounter || 0; %>
            <!-- â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šæ¤œç´¢ãƒ»ã‚½ãƒ¼ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’data-*å±æ€§ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€ â–¼â–¼â–¼ -->
            <div class="thread-item"
                 data-thread-id="<%= t.id %>"
                 data-last-updated-at="<%= t.lastUpdatedAt %>"
                 data-created-at="<%= t.createdAt %>"
                 data-post-counter="<%= postCount %>"
                 data-title="<%= t.title %>"
                 data-tags="<%= (t.tags || []).join(',') %>">
              <% if (t.previewImg) { %>
                <img src="<%= t.previewImg %>" class="thread-preview-img" alt="preview">
              <% } %>
              <div class="thread-info">
                <div class="thread-title-wrapper">
                  <a class="thread-link" href="thread-<%= t.id %>.html">
                    <%= t.title.replace(/#[\p{L}\p{N}_]+/ug, '').trim() %>
                  </a>
                </div>
                <div class="thread-tags">
                  <% (t.tags || []).forEach(tag => { %>
                    <a href="#" class="tag" data-tag="<%= tag %>"><%= tag %></a>
                  <% }) %>
                </div>
              </div>
              <div class="thread-meta-info">
                <div class="meta"><%= postCount %>ãƒ¬ã‚¹</div>
                <div class="meta"></div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="small-muted">ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
        <% } %>
      </div>
      <!-- â–²â–²â–² ã“ã“ã¾ã§ãŒEJSã«ã‚ˆã‚‹HTMLç”Ÿæˆéƒ¨åˆ† â–²â–²â–² -->

      <div id="paginationContainer"></div>
    </div>
  </div>

  <div id="profileModal" class="modal-overlay"><!-- ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... --></div>
  <div id="imageLightbox" class="lightbox-overlay"><!-- ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... --></div>
  <div id="voteModal" class="modal-overlay"><!-- ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... --></div>
  <div id="anchorModal" class="modal-overlay"><!-- ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... --></div>
  <div id="drawingModal" class="modal-overlay"><!-- ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... --></div>
  <audio id="notificationSound" src="https://otologic.jp/sounds/se/mp3/single-accent-19.mp3" preload="auto"></audio>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDS3Tlr9Oc4z5Kz2Zg72p9VRayPSAbmwTw",
  authDomain: "config-f5509.firebaseapp.com",
  databaseURL: "https://config-f5509-default-rtdb.firebaseio.com",
  projectId: "config-f5509",
  storageBucket: "config-f5509.appspot.com",
  messagingSenderId: "513023904601",
  appId: "1:513023904601:web:1846aa87aec5de306e1a48",
  measurementId: "G-KT2LZC2EED"
};

const ACHIEVEMENTS_MASTER = { /* ... ä¸­èº«ã¯å¤‰æ›´ãªã— ... */ };
const NG_WORDS = ['ë°”ë³´', 'ë©ì²­ì´', 'ì£½ì–´', 'æ­»ã­', 'ãƒã‚«', 'é¦¬é¹¿', 'kill', 'idiot'];
const ADMIN_IDS = ['W4ZZKXRY9CS'];

// â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦allThreadsã‚’å®šç¾© â–¼â–¼â–¼
let allThreads = [];

document.addEventListener('DOMContentLoaded', () => { main(); });

function main() {
  // ... audioContextã‚„FirebaseåˆæœŸåŒ–ãªã©ã¯å¤‰æ›´ãªã— ...
  try { firebase.initializeApp(firebaseConfig); } catch (e) { /* ... */ }
  const db = firebase.database();
  
  // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¸€åº¦ã ã‘ã€HTMLã‹ã‚‰ã‚¹ãƒ¬ãƒƒãƒ‰æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§allThreadsã‚’å¾©å…ƒã™ã‚‹ â–¼â–¼â–¼
  document.querySelectorAll('#threadListContainer .thread-item').forEach(el => {
    allThreads.push({
        id: el.dataset.threadId,
        lastUpdatedAt: parseInt(el.dataset.lastUpdatedAt, 10),
        createdAt: parseInt(el.dataset.createdAt, 10),
        postCounter: parseInt(el.dataset.postCounter, 10),
        title: el.dataset.title,
        tags: el.dataset.tags ? el.dataset.tags.split(',') : [],
        // DOMè¦ç´ ãã®ã‚‚ã®ã‚‚ä¿æŒã—ã¦ãŠãã¨ã€ä¸¦ã¹æ›¿ãˆã‚„è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆãŒç°¡å˜
        element: el 
    });
  });

  // ... banRef.on(...)ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€renderAppã¨renderHomeä»¥å¤–ã¯ã»ã¼å¤‰æ›´ãªã— ...

  let activeDataListener = null, activeViewersListener = null, myConnectionRef = null, currentViewers = 0, currentPage = 1;
  const THREADS_PER_PAGE = 15;
  
  // ... cleanupListeners() ã‹ã‚‰ goHome() ã¾ã§ã€ã»ã¨ã‚“ã©ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã¯å¤‰æ›´ãªã— ...

  // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šdisplayThreadsé–¢æ•°ã‚’ã€DOMã‚’ç›´æ¥æ“ä½œã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«å®Œå…¨ã«æ›¸ãæ›ãˆã‚‹ â–¼â–¼â–¼
  function displayThreads() {
    const c = document.getElementById('threadListContainer'); 
    const p = document.getElementById('paginationContainer');
    if(!c || !p) return;

    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const reverseCheckbox = document.getElementById('sortReverseCheckbox');

    const sortMode = sortSelect.value;
    const searchTerm = searchInput.value.trim().toLowerCase();
    const isReversed = reverseCheckbox.checked;

    // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚° (æ¤œç´¢)
    let filteredThreads = allThreads.filter(t => {
      if (!searchTerm) return true; // æ¤œç´¢ãƒ¯ãƒ¼ãƒ‰ãŒãªã‘ã‚Œã°å…¨ã¦è¡¨ç¤º
      if (searchTerm.startsWith('#')) {
        const tag = searchTerm.substring(1);
        return t.tags.includes(tag);
      }
      return t.title.toLowerCase().includes(searchTerm);
    });

    // 2. ã‚½ãƒ¼ãƒˆ (ä¸¦ã³æ›¿ãˆ)
    let sortedThreads = [...filteredThreads].sort((a, b) => {
      if (sortMode === 'newPost') return b.lastUpdatedAt - a.lastUpdatedAt;
      if (sortMode === 'newThread') return b.createdAt - a.createdAt;
      if (sortMode === 'manyRes') return b.postCounter - a.postCounter;
      // 'momentum'ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯è¨ˆç®—ãŒé›£ã—ã„ãŸã‚ã€ä¸€æ—¦ 'newPost' ã¨åŒã˜æŒ™å‹•ã«ã™ã‚‹
      if (sortMode === 'momentum') return b.lastUpdatedAt - a.lastUpdatedAt;
      return 0;
    });

    if (isReversed) {
      sortedThreads.reverse();
    }
    
    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¨ˆç®—
    const totalPages = Math.max(1, Math.ceil(sortedThreads.length / THREADS_PER_PAGE));
    currentPage = Math.min(currentPage, totalPages);
    const startIndex = (currentPage - 1) * THREADS_PER_PAGE;
    const endIndex = startIndex + THREADS_PER_PAGE;
    const pagedThreads = sortedThreads.slice(startIndex, endIndex);

    // 3. è¡¨ç¤º/éè¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
    // ã¾ãšå…¨ã¦ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ä¸€æ—¦éè¡¨ç¤ºã«ã™ã‚‹
    allThreads.forEach(t => t.element.style.display = 'none');
    
    // ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã™ã¹ãã‚¹ãƒ¬ãƒƒãƒ‰ã ã‘ã‚’è¡¨ç¤ºã™ã‚‹
    pagedThreads.forEach(t => t.element.style.display = 'flex');

    if(pagedThreads.length === 0){
      // è¡¨ç¤ºã™ã¹ãã‚¹ãƒ¬ãƒƒãƒ‰ãŒãªã„å ´åˆã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®è¦ç´ ã‚’æ›¸ãæ›ãˆã‚‹ã®ã§ã¯ãªãã€è¿½åŠ ãƒ»å‰Šé™¤ã™ã‚‹ï¼‰
      let noResultEl = c.querySelector('.no-result-message');
      if (!noResultEl) {
        noResultEl = document.createElement('div');
        noResultEl.className = 'small-muted no-result-message';
        c.appendChild(noResultEl);
      }
      noResultEl.textContent = 'è©²å½“ã™ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
    } else {
      let noResultEl = c.querySelector('.no-result-message');
      if (noResultEl) noResultEl.remove();
    }

    // ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’æ›´æ–°
    if (sortedThreads.length > THREADS_PER_PAGE) {
      p.innerHTML = `
        <div class="pagination-controls">
          <button id="prevPageBtn" class="btn small" ${currentPage === 1 ? 'disabled' : ''}>å‰ã¸</button>
          <span class="small-muted">${currentPage} / ${totalPages} ãƒšãƒ¼ã‚¸</span>
          <button id="nextPageBtn" class="btn small" ${currentPage === totalPages ? 'disabled' : ''}>æ¬¡ã¸</button>
        </div>
      `;
      document.getElementById('prevPageBtn').onclick = () => { if(currentPage > 1) { currentPage--; displayThreads(); } };
      document.getElementById('nextPageBtn').onclick = () => { if(currentPage < totalPages) { currentPage++; displayThreads(); } };
    } else {
      p.innerHTML = '';
    }
  }

  // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šrenderHomeé–¢æ•°ã‚’ã€ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªã‚‚ã®ã«å¤‰æ›´ â–¼â–¼â–¼
  function renderHome() {
    currentPage = 1;
    
    // å„ç¨®ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    const sortSelect = document.getElementById('sortSelect');
    const searchInput = document.getElementById('searchInput');
    const reverseCheckbox = document.getElementById('sortReverseCheckbox');

    if (sortSelect) sortSelect.onchange = () => { currentPage = 1; displayThreads(); };
    if (reverseCheckbox) reverseCheckbox.onchange = () => { currentPage = 1; displayThreads(); };
    if (document.getElementById('searchBtn')) document.getElementById('searchBtn').onclick = () => { currentPage = 1; displayThreads(); };
    if (document.getElementById('clearSearchBtn')) document.getElementById('clearSearchBtn').onclick = () => { searchInput.value=''; currentPage = 1; displayThreads(); };
    if (searchInput) searchInput.onkeydown = (e) => { if(e.key === 'Enter') { currentPage = 1; displayThreads(); } };

    // ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆãƒœã‚¿ãƒ³ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—
    if (document.getElementById('createThreadBtn')) document.getElementById('createThreadBtn').onclick=async()=>{
        // ... (å…ƒã®ã‚¹ãƒ¬ãƒƒãƒ‰ä½œæˆãƒ­ã‚¸ãƒƒã‚¯ã¯ãã®ã¾ã¾) ...
    };
    
    // ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã‚„ãŠçµµæããƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚‚å¤‰æ›´ãªã—
    setupVoteModal('newText');
    setupDrawingModal('newImageContainer');
    
    // æ¬¡ã‚¹ãƒ¬ä½œæˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã‚‚å¤‰æ›´ãªã—
    // ...
  }
  
  // â–¼â–¼â–¼ å¤‰æ›´ç‚¹ï¼šrenderAppé–¢æ•°ã‹ã‚‰ã€ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸è¡¨ç¤ºæ™‚ã®ãƒ‡ãƒ¼ã‚¿å–å¾—å‡¦ç†ã‚’å‰Šé™¤ â–¼â–¼â–¼
  async function renderApp(){
    exitEditMode();
    cleanupListeners();
    currentViewers = 0;
    refreshHeader();
    await setupUnreadListeners();

    const h = location.hash || '#';
    // ã‚¹ãƒ¬ãƒƒãƒ‰è©³ç´°ã€å±¥æ­´ã€è¨­å®šãªã©ã®ãƒšãƒ¼ã‚¸é·ç§»ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—
    if (h.startsWith('#thread-')) {
      // ...
    } else if (h === '#history') {
      // ...
    } else if (h === '#settings') {
      // ...
    } else if (h === '#memories') {
      // ...
    } else {
      // ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã®å ´åˆã®å‡¦ç†
      renderHome(); // HTMLè¦ç´ ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
      displayThreads(); // åˆæœŸè¡¨ç¤ºï¼ˆå…¨ä»¶è¡¨ç¤ºï¼‰ã‚’å®Ÿè¡Œã™ã‚‹
    }
  }
  
  // ... ã“ã‚Œã‚ˆã‚Šä¸‹ã®å„ç¨®é–¢æ•°ï¼ˆrenderThread, postReplyãªã©ï¼‰ã¯åŸºæœ¬çš„ã«å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ ...

  renderApp(); // æœ€åˆã«ä¸€åº¦å‘¼ã³å‡ºã™
}
</script>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</body>
</html>