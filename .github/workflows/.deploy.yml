# .github/workflows/deploy.yml

# この自動化ルールの名前です
name: Build and Deploy to GitHub Pages

# このルールをいつ実行するかの設定です
on:
  # 1. 5分ごとに自動実行します
  schedule:
    - cron: '*/5 * * * *'
  
  # 2. GitHubのActionsタブから手動でも実行できるようにします
  workflow_dispatch:
  
  # 3. mainブランチにプッシュ（アップロード）したときも実行します
  push:
    branches:
      - main

# 実行する作業内容です
jobs:
  build-and-deploy:
    # 最新のUbuntu（Linux）環境で作業します
    runs-on: ubuntu-latest
    steps:
      # ステップ1：リポジトリのファイルを仮想環境にコピーします
      - name: Checkout 🛎️
        uses: actions/checkout@v4

      # ステップ2：Node.jsを使えるように準備します
      - name: Setup Node.js 🟩
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # ステップ3：必要なライブラリをインストールします (npm install)
      - name: Install dependencies 📦
        run: npm install

      # ステップ4：build.js を実行して、サイトを生成します
      - name: Build static site 🔨
        run: node build.js
        env:
          # ここで、ステップ4で設定した秘密の鍵を build.js に渡します
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # ステップ5：生成されたサイト（distフォルダの中身）を公開します
      - name: Deploy to GitHub Pages 🚀
        uses: peaceiris/actions-gh-pages@v3
        with:
          # GitHubが自動で発行してくれる特別なトークンです
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # build.js が出力した dist フォルダを公開対象にします
          publish_dir: ./dist